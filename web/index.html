<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRISIS38 · Centre opérationnel Isère</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="shell">
    <section id="home-view" class="home-wrap">
      <header class="home-topbar">
        <div class="brand">
          <p class="tag">Protection Civile · Isère</p>
          <strong>CRISIS38</strong>
        </div>
        <button id="mobile-menu-btn" class="menu-toggle" type="button" aria-expanded="false" aria-controls="home-nav">☰</button>
        <nav id="home-nav" class="home-nav">
          <a href="#home-features">Fonctionnalités</a>
          <a href="#home-connectors">Interconnexions</a>
          <a href="#home-actions">Actions</a>
          <button id="open-login-btn" type="button">Espace sécurisé</button>
        </nav>
      </header>

      <section class="home-hero">
        <div>
          <p class="tag">Poste de commandement numérique</p>
          <h1>Un outil opérationnel clair, accessible et connecté</h1>
          <p class="lead">Tableau de bord unifié pour la vigilance météo, les crues, la coordination des communes et la gestion des actions terrain en Isère.</p>
          <div class="hero-actions">
            <button id="hero-login-btn" type="button">Se connecter</button>
            <button id="scroll-actions-btn" type="button" class="ghost">Voir les procédures rapides</button>
          </div>
        </div>
        <article class="hero-status panel">
          <h3>Données temps réel · Isère</h3>
          <p>Niveau météo <strong id="home-meteo-state">-</strong></p>
          <p>Niveau crues <strong id="home-river-state">-</strong></p>
          <p>Risque global <strong id="home-global-risk">-</strong></p>
          <p>Communes en crise <strong id="home-crisis-count">0</strong></p>
          <p>Sismicité max (Géorisques) <strong id="home-seismic-state">-</strong></p>
          <p>Documents inondation (Géorisques) <strong id="home-flood-docs">0</strong></p>
          <p class="muted" id="home-live-updated">Dernière mise à jour: -</p>
          <p class="error" id="home-live-error"></p>
        </article>
      </section>

      <section id="home-features" class="home-grid">
        <article class="panel feature-card"><h3>Menu structuré</h3><p>Navigation claire entre situation, services, communes, main courante, carte et utilisateurs.</p></article>
        <article class="panel feature-card"><h3>Interopérabilité</h3><p>Connexion et consolidation des flux Météo-France, Vigicrues et services institutionnels.</p></article>
        <article class="panel feature-card"><h3>Accessibilité</h3><p>Contrastes renforcés, composants larges, lecture rapide des états critiques et compatibilité mobile.</p></article>
      </section>

      <section id="home-connectors" class="panel connectors">
        <h2>Écosystème interconnecté</h2>
        <p class="muted">Sources exploitables via API, flux institutionnels et portails métiers.</p>
        <div class="connector-grid">
          <article><h4>Météo-France Vigilance</h4><p>Bulletins et niveaux de vigilance départementale.</p></article>
          <article><h4>Vigicrues</h4><p>Stations hydrologiques et niveaux d'alerte eau.</p></article>
          <article><h4>Préfecture de l'Isère</h4><p>Coordination institutionnelle et informations officielles.</p></article>
          <article><h4>Géorisques</h4><p>Connaissance des aléas naturels locaux.</p></article>
          <article><h4>Info Route Isère</h4><p>Suivi de circulation et coupures d'axes.</p></article>
          <article><h4>PCS / ORSEC</h4><p>Référentiels internes pour la réponse opérationnelle.</p></article>
        </div>
      </section>

      <section id="home-actions" class="panel quick-actions">
        <h2>Vue opérationnelle immédiate</h2>
        <p class="muted">L'accueil affiche uniquement des données réelles consolidées (base locale + services institutionnels). Connectez-vous pour la main courante, les communes et les documents ORSEC.</p>
      </section>
    </section>

    <section id="login-view" class="auth-wrap hidden" hidden>
      <form id="login-form" class="panel auth-card" method="post" action="#" autocomplete="off">
        <p class="tag">Protection Civile · Isère</p>
        <h1>Connexion CRISIS38</h1>
        <p class="lead">Accès au centre opérationnel et aux services connectés.</p>
        <label>Identifiant<input name="username" required /></label>
        <label>Mot de passe<input name="password" type="password" required /></label>
        <button type="submit">Connexion sécurisée</button>
        <button id="back-home-btn" type="button" class="ghost">Retour accueil</button>
        <p id="login-error" class="error"></p>
      </form>

      <form id="password-form" class="panel auth-card hidden" hidden method="post" action="#" autocomplete="off">
        <h2>Nouveau mot de passe</h2>
        <label>Nouveau mot de passe<input name="new_password" type="password" minlength="8" required /></label>
        <button type="submit">Valider</button>
        <p id="password-error" class="error"></p>
      </form>
    </section>

    <section id="app-view" class="app hidden" hidden>
      <aside id="app-sidebar" class="panel sidebar">
        <div class="sidebar-header">
          <p class="tag">Centre de commandement</p>
          <h2>Isère · 38</h2>
          <p class="muted">Rôle <strong id="current-role">-</strong></p>
          <p class="muted">Commune <strong id="current-commune">Toutes</strong></p>
        </div>
        <nav class="side-nav" aria-label="Menu principal">
          <button class="menu-btn" data-target="situation-panel">Situation</button>
          <button class="menu-btn" data-target="services-panel">Services connectés</button>
          <button class="menu-btn" data-target="supervision-panel">Supervision crise</button>
          <button class="menu-btn" data-target="municipalities-panel">Communes</button>
          <button class="menu-btn" data-target="logs-panel">Main courante</button>
          <button class="menu-btn" data-target="map-panel">Carte Isère</button>
          <button class="menu-btn" data-target="users-panel">Utilisateurs</button>
        </nav>
        <button id="logout-btn" class="danger">Déconnexion</button>
      </aside>

      <section class="content">
        <header class="panel app-header">
          <button id="app-menu-btn" class="menu-toggle" type="button" aria-expanded="false" aria-controls="app-sidebar">☰ Menu</button>
          <div>
            <p class="tag">Pilotage en temps réel</p>
            <h1 id="panel-title">Situation opérationnelle</h1>
          </div>
          <div class="header-actions">
            <button id="refresh-btn" class="ghost" type="button">Actualiser</button>
            <p id="dashboard-error" class="error"></p>
          </div>
        </header>

        <section id="situation-panel" class="panel view">
          <div class="kpis">
            <article class="tile"><h3>Vigilance météo</h3><p id="vigilance">-</p></article>
            <article class="tile"><h3>Niveau crues</h3><p id="crues">-</p></article>
            <article class="tile"><h3>Risque global</h3><p id="risk">-</p></article>
            <article class="tile"><h3>Communes en crise</h3><p id="crisis">0</p></article>
          </div>
          <h3>Risques en cours (orange / rouge)</h3>
          <ul id="critical-risks-list" class="list"></ul>
          <h3>Derniers évènements</h3>
          <ul id="latest-logs" class="list"></ul>
        </section>

        <section id="supervision-panel" class="panel view hidden" hidden>
          <h3>Supervision multi-aléas Isère</h3>
          <div class="kpis">
            <article class="tile"><h3>Météo-France</h3><p id="supervision-meteo">-</p></article>
            <article class="tile"><h3>Vigicrues</h3><p id="supervision-vigicrues">-</p></article>
            <article class="tile"><h3>Itinisère</h3><p id="supervision-itinisere">-</p></article>
            <article class="tile"><h3>Géorisques</h3><p id="supervision-georisques">-</p></article>
            <article class="tile"><h3>Communes en crise</h3><p id="supervision-crisis-count">0</p></article>
          </div>
          <h4>Historique opérationnel récent</h4>
          <ul id="supervision-timeline" class="list"></ul>
          <h4>Perturbations mobilité (Itinisère)</h4>
          <ul id="supervision-itinisere-events" class="list"></ul>
        </section>

        <section id="services-panel" class="panel view hidden" hidden>
          <h3>Écosystème de données et services connectés (Isère)</h3>
          <div class="services-grid">
            <article class="service-card">
              <h4>Météo-France Vigilance</h4>
              <p id="meteo-status">-</p>
              <p id="meteo-info" class="muted"></p>
              <!-- Debut code vignette vigilance départementale  Météo-France -->
              <iframe
                class="meteo-widget"
                src="https://vigilance.meteofrance.fr/fr/widget-vigilance/vigilance-departement/38"
                width="302"
                height="122"
                frameborder="0"
                title="Vignette vigilance départementale Météo-France"
                loading="lazy"
              ></iframe>
              <!-- FIN -->
            </article>
            <article class="service-card"><h4>Vigicrues</h4><p id="vigicrues-status">-</p><p id="vigicrues-info" class="muted"></p></article>
            <article class="service-card"><h4>Préfecture de l'Isère</h4><p>Coordination institutionnelle</p><a href="https://www.isere.gouv.fr" target="_blank" rel="noreferrer">isère.gouv.fr</a></article>
            <article class="service-card"><h4>Vigicrues Flash</h4><p>Veille pluie-inondation</p><a href="https://www.vigicrues.gouv.fr" target="_blank" rel="noreferrer">vigicrues.gouv.fr</a></article>
            <article class="service-card"><h4>GEORISQUES</h4><p id="georisques-status">-</p><p id="georisques-info" class="muted"></p><a href="https://www.georisques.gouv.fr" target="_blank" rel="noreferrer">georisques.gouv.fr</a></article>
            <article class="service-card"><h4>Info route Isère</h4><p id="itinisere-status">-</p><a href="https://www.itinisere.fr" target="_blank" rel="noreferrer">itinisere.fr</a></article>
          </div>
          <h4>Alertes météo Isère (en cours / demain)</h4>
          <ul id="meteo-alerts-list" class="list"></ul>
          <h4>Stations Vigicrues prioritaires</h4>
          <ul id="stations-list" class="list"></ul>
        </section>

        <section id="municipalities-panel" class="panel view hidden" hidden>
          <h3>Communes & fiches pratiques</h3>
          <form id="municipality-form" class="form" data-requires-edit>
            <input name="name" placeholder="Nom commune" required />
            <input name="manager" placeholder="Responsable" required />
            <input name="phone" placeholder="Téléphone" required />
            <input name="email" placeholder="Email" type="email" required />
            <input name="postal_code" placeholder="Code postal" pattern="[0-9]{5}" maxlength="5" required />
            <button type="submit">Ajouter</button>
          </form>
          <ul id="municipalities-list" class="list"></ul>
        </section>

        <section id="logs-panel" class="panel view hidden" hidden>
          <h3>Main courante</h3>
          <form id="log-form" class="form" data-requires-edit>
            <input name="event_type" placeholder="Type d'évènement" required />
            <input name="description" placeholder="Description opérationnelle" required />
            <button type="submit">Ajouter</button>
          </form>
          <ul id="logs-list" class="list"></ul>
        </section>

        <section id="map-panel" class="panel view hidden" hidden>
          <h3>Carte stratégique Isère</h3>
          <div class="map-toolbar">
            <input id="map-search" type="search" placeholder="Rechercher une adresse ou un nom" />
            <button id="map-search-btn" type="button">Rechercher</button>
            <button id="map-fit-btn" type="button" class="ghost">Voir tous les points</button>
            <button id="map-add-point-toggle" type="button" class="ghost">Mode ajout: désactivé</button>
            <label><input id="filter-hydro" type="checkbox" checked /> Stations Vigicrues</label>
            <label><input id="filter-pcs" type="checkbox" checked /> Communes PCS</label>
            <label><input id="filter-resources-active" type="checkbox" /> Ressources activées</label>
            <select id="resource-type-filter">
              <option value="all">Toutes les ressources</option>
              <option value="poste_commandement">Postes de commandement</option>
              <option value="centre_hebergement">Centres d'hébergement</option>
              <option value="hopital">Hôpitaux</option>
              <option value="caserne">Casernes</option>
            </select>
          </div>
          <p id="map-feedback" class="muted"></p>
          <div id="isere-map-leaflet" class="leaflet-map" aria-label="Carte interactive Isère"></div>
          <div class="map-layout">
            <div>
              <p>Niveau météo <strong id="meteo-level">-</strong></p>
              <p>Risques météo concernés <strong id="meteo-hazards">-</strong></p>
              <p>Niveau hydrologique <strong id="river-level">-</strong></p>
              <p>Sismicité max <strong id="map-seismic-level">-</strong></p>
              <p>Docs inondation suivis <strong id="map-flood-docs">0</strong></p>
              <p class="muted" id="map-source">Source carte: chargement…</p>
              <div class="legend">
                <span class="badge green">Vert</span>
                <span class="badge yellow">Jaune</span>
                <span class="badge orange">Orange</span>
                <span class="badge red">Rouge</span>
              </div>
            </div>
            <div>
              <h4>Cours d'eau Vigicrues</h4>
              <ul id="hydro-stations-list" class="list practical"></ul>
              <h4>Communes avec PCS</h4>
              <ul id="pcs-list" class="list practical"></ul>
              <h4>Ressources cartographiées</h4>
              <ul id="resources-list" class="list practical"></ul>
              <h4>Points personnalisés</h4>
              <ul id="custom-points-list" class="list practical"></ul>
              <h4>Alertes mobilité Itinisère</h4>
              <ul id="itinerary-list" class="list practical"></ul>
            </div>
          </div>
        </section>

        <section id="users-panel" class="panel view hidden" hidden>
          <h3>Comptes utilisateurs</h3>
          <table class="users-table">
            <thead><tr><th>Utilisateur</th><th>Rôle</th><th>Commune</th><th>Créé le</th><th>Statut</th></tr></thead>
            <tbody id="users-table"></tbody>
          </table>
        </section>
      </section>
    </section>
  </main>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Compatibilité avec d'anciens scripts qui pilotent #isere-shape. -->
  <svg aria-hidden="true" width="0" height="0" focusable="false" style="position:absolute">
    <path id="isere-shape" d="M0 0h1v1H0z"></path>
  </svg>
  <script src="/script.js"></script>
</body>
</html>
